library(tidyverse)

## Create your goal tibble to replicate

# # Run this line to see what your end product should look like
# sw.wrangled.goal <- read_csv("data/sw-wrangled.csv") %>% 
#   mutate(across(c(hair, gender, species, homeworld), factor)) # this is a quick-and-dirty fix to account for odd importing behavior
# 
# # View in console
# sw.wrangled.goal 
# 
# # Examine the structure of the df and take note of data types
# # Look closely at factors (you may need another function to do so) to see their levels
# str(sw.wrangled.goal) 
# 
# 
# 
# ## Use the built-in starwars dataset to replicate the tibble above in a tbl called sw.wrangled
# # If you get stuck, use comments to "hold space" for where you know code needs to go to achieve a goal you're not sure how to execute
# sw.wranged <- starwars # %>% ...
# 
# 
# 
# ## Check that your sw.wrangled df is identical to the goal df
# # Use any returned information about mismatches to adjust your code as needed
# all.equal(sw.wrangled.goal, sw.wrangled.goal)
view(starwars)

sw.wrangled <- starwars %>% 
  # Select only needed columns & rename height (to height_cm) and hair_color (to hair)
  select(name, height_cm = height, mass, hair = hair_color, gender, species, homeworld) %>% 
  # Filter out any rows where height data is missing
  filter(!is.na(height_cm)) %>% 
  # Break names into two columns (first_name, last_name); use first space " " as delimiter
  ## too_many="merge": if more than one delim (space) is found, merge everything after the space into the second column
  ## too_few="align_start": if less than one delim is found, treat the name like a first name and make last_name NA
  ## notice where in the column order the new columns appear vs if you did this with a mutate 
  separate_wider_delim(name, delim=" ", names = c("first_name", "last_name"), too_many="merge", too_few = "align_start") %>% 
  # Change categorical variables to factors
  mutate(
    ## for the 2 detected levels of gender (feminine, masculine) relabel (i.e., rename/replace those values) with f & m
    gender = factor(gender, levels = c("feminine", "masculine"), labels = c("f", "m")),
    ## convert character values in species to all upper case before creating factor levels
    species = factor(str_to_upper(species)),
    homeworld = factor(homeworld)) %>% 
  # create a second height column by converting cm to inches
  mutate(height_in = height_cm*.3937) %>% 
  # where there is no value in hair, use value "bald"
  mutate(hair = factor(replace_na(hair, "bald"))) %>% 
  # create a logical variable that returns true if "brown" is anywhere in the string value for hair 
  mutate(brown_hair = str_detect(hair, "brown")) %>% 
  # create an initials column by concatenating the first characters of the first and last name
  ## str_sub(colname, 1, 1) -- the '1,1' bit means the first character to include is the one in position 1
  ## and the last is in position 1 (so just the first character)
  mutate(initials = paste0(str_sub(first_name, 1, 1), str_sub(last_name, 1, 1))) %>% 
  # move the new height_in column to be immediately left of the height_cm column 
  relocate(height_in, .before = height_cm) %>% 
  # move the new initials column to be immediately right of the last_name column
  relocate(initials, .after = last_name) %>% 
  # sort by last_name and then (when last_name matches) by first_name
  arrange(last_name, first_name)

view(sw.wrangled)
#write_csv(sw.wrangled, "data/sw-wrangled.csv")

# plot 1
ggplot(data = sw.wrangled) + 
  geom_histogram(aes(x = height_cm))

# plot 2
ggplot(data = sw.wrangled) + 
  geom_histogram(aes(x = hair), stat = "count")

# plot 3
ggplot(data = sw.wrangled) + 
  geom_point(shape = 17, aes(x = height_in, y = mass)) + 
  xlim(20,100) + ylim(0,165)

# intermediate plot 1
sw.wrangled$hair <- factor(sw.wrangled$hair, levels = c("none", "brown", "black", "bald", "white", "blond", "auburn, white", "blonde", "brown, grey", "grey"))
ggplot(data = sw.wrangled) +
  geom_boxplot(aes(x = hair, y = mass, fill = hair)) +
  ylim(0,160) +
  scale_fill_manual(values = c("red", "orange", "yellow", "green", "seagreen", "lightblue", "blue", "purple", "pink", "hotpink")) +
  labs(x = "Hair color(s)", y = "Mass(kg)")

# intermediate plot 2
ggplot(data = sw.wrangled, aes(x = mass, y = height_in)) +
  facet_wrap(~ brown_hair) +
  geom_point() +
  scale_x_continuous(limits = c(-200,200)) +
  geom_smooth(method = "lm", color = "blue") +
  labs(title = "Mass vs. height by brown-hair-havingness",
       subtitle = "A critically irrelevant analysis") +
  theme_minimal()

# intermediate plot 3
sw.wrangled <- sw.wrangled %>% 
  mutate(species_first_letter = substr(species, 1, 1))
ggplot(data = sw.wrangled, aes(y = species_first_letter, fill = gender)) +
  geom_bar()

# advanced plot (i'm going to really try here but it's very possible it will be the worst thing i've ever done in my life)
library(ggsci)

sw.wrangled <- sw.wrangled %>% 
  mutate(gender = ifelse(is.na(gender), "Other",
                         ifelse(gender == "m", "Male",
                                ifelse(gender == "f", "Female", gender))))

ggplot(data = sw.wrangled, aes(x = height_cm, y = mass, color = gender)) +
  theme_classic() +
  facet_wrap(vars(gender), scales = "free_y") +
  geom_smooth(method = "lm", fill = "#E9E1F5", alpha = 0.9) +
  geom_point(position = "identity", alpha = 0.5) +
  scale_color_uchicago() +
  scale_x_continuous(breaks = seq(60, 270, by = 30)) +
  labs(
          title = "Height and weight across gender presentation",
          subtitle = 'A cautionary tale in misleading "free" axis scales & bad design choices',
          x = "Height (cm)",
          y = "Mass (kg)",
          color = "Gender Presentation"
        ) +
  theme(
    text = element_text(family = "Comic Sans MS",
                        face = "plain",
                        size = 9),
    strip.background = element_rect(fill = "#036402"),
    panel.background = element_rect(fill = "#FFEEEE"),
    panel.grid.major.y = element_line(color = "grey", linetype = 4, size = 1),
    panel.grid.major.x = element_line(color = "white", linetype = 2, size = 0.5),
    strip.text = element_text(color = "white", family = "Courier", hjust = 0),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    legend.title = element_text(family = "Brush Script MT", size = 16),
    legend.background = element_rect(fill = "#CBCCFF")
    )
# yay, mostly